<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PsychoPortal</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg: #0d1117; --surface: #161b22; --surface2: #1c2128; --border: #30363d;
      --text: #e6edf3; --muted: #8b949e; --accent: #c678dd;
      --green: #3fb950; --yellow: #d29922; --red: #f85149;
      --blue: #58a6ff; --orange: #f0883e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* â”€â”€ Header â”€â”€ */
    #header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 8px 16px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    #logo { font-size: 1.1rem; font-weight: 700; color: var(--accent); letter-spacing: 1px; white-space: nowrap; }
    #status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; flex-shrink: 0; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .badge { background: var(--border); color: var(--muted); font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; white-space: nowrap; }
    .badge.domain { background: #1e3a2f; color: var(--green); }
    #header-right { margin-left: auto; display: flex; gap: 8px; align-items: center; }
    .hdr-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 5px 12px; font-size: 0.8rem; cursor: pointer; transition: all .2s; white-space: nowrap; }
    .hdr-btn:hover { border-color: var(--accent); color: var(--accent); }
    .hdr-btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .hdr-btn.primary:hover { opacity: .85; }
    .notif-bell { position: relative; }
    .notif-count { position: absolute; top: -4px; right: -4px; background: var(--red); color: #fff; font-size: 0.6rem; font-weight: 700; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
    .notif-count.hidden { display: none; }

    /* â”€â”€ Notification modal â”€â”€ */
    #notif-modal { position: fixed; top: 50px; right: 16px; width: 360px; max-height: 500px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); z-index: 1100; display: none; flex-direction: column; overflow: hidden; }
    #notif-modal.open { display: flex; }
    #notif-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    #notif-header h3 { font-size: 0.9rem; color: var(--accent); }
    #notif-list { flex: 1; overflow-y: auto; padding: 8px; }
    .notif-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer; transition: border-color .15s; }
    .notif-item:hover { border-color: var(--accent); }
    .notif-item.unread { border-left: 3px solid var(--accent); }
    .notif-title { font-size: 0.85rem; font-weight: 600; color: var(--text); margin-bottom: 4px; }
    .notif-msg { font-size: 0.78rem; color: var(--muted); }
    .notif-time { font-size: 0.7rem; color: var(--muted); margin-top: 4px; }
    .notif-empty { text-align: center; color: var(--muted); font-size: 0.85rem; padding: 24px; }

    /* â”€â”€ Personality panel â”€â”€ */
    #personality-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 480px; max-height: 80vh; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 12px 48px rgba(0,0,0,0.7); z-index: 1200; display: none; flex-direction: column; overflow: hidden; }
    #personality-modal.open { display: flex; }
    #personality-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1199; display: none; }
    #personality-overlay.open { display: block; }
    #personality-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: var(--surface2); }
    #personality-header h2 { font-size: 1rem; color: var(--accent); }
    #personality-body { padding: 20px; overflow-y: auto; flex: 1; }
    .trait-row { margin-bottom: 16px; }
    .trait-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .trait-name { font-size: 0.85rem; font-weight: 600; color: var(--text); }
    .trait-val { font-size: 0.85rem; color: var(--accent); font-weight: 700; font-family: monospace; }
    .trait-slider { width: 100%; -webkit-appearance: none; appearance: none; height: 4px; border-radius: 2px; background: var(--border); outline: none; cursor: pointer; }
    .trait-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; }
    .trait-desc { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }
    #personality-footer { padding: 12px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
    .tars-label { font-size: 0.72rem; color: var(--muted); text-align: center; margin-bottom: 12px; font-style: italic; }

    /* â”€â”€ Layout â”€â”€ */
    #main { display: flex; flex: 1; overflow: hidden; }

    /* â”€â”€ Left sidebar (history) â”€â”€ */
    #history-panel { width: 220px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; transition: width .25s; }
    #history-panel.collapsed { width: 0; }
    #history-inner { width: 220px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    #history-header { padding: 10px 12px; font-size: 0.7rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    #sessions-list { flex: 1; overflow-y: auto; padding: 6px; }
    #sessions-list::-webkit-scrollbar { width: 4px; }
    #sessions-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    .session-item { padding: 8px 10px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; border: 1px solid transparent; transition: all .15s; }
    .session-item:hover { background: var(--surface2); border-color: var(--border); }
    .session-item.active { background: #1e1a2f; border-color: #4a3080; }
    .session-date { font-size: 0.72rem; color: var(--muted); }
    .session-count { font-size: 0.68rem; color: var(--muted); }
    .session-label { font-size: 0.8rem; color: var(--text); font-weight: 500; margin-bottom: 2px; }
    .current-tag { font-size: 0.62rem; background: #1e3a2f; color: var(--green); padding: 1px 5px; border-radius: 6px; margin-left: 4px; }

    /* â”€â”€ Chat panel â”€â”€ */
    #chat-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; }

    /* â”€â”€ Messages â”€â”€ */
    #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .msg { max-width: 90%; }
    .msg.user { align-self: flex-end; }
    .msg.agent { align-self: flex-start; }
    .msg-label { font-size: 0.68rem; color: var(--muted); margin-bottom: 4px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }
    .msg.user .msg-label { text-align: right; }
    .msg-bubble { padding: 12px 16px; border-radius: 12px; line-height: 1.6; font-size: 0.92rem; }
    .msg.user .msg-bubble { background: #1c2b3a; border: 1px solid #2d4a6e; color: var(--blue); }
    .msg.agent .msg-bubble { background: var(--surface); border: 1px solid var(--border); }
    .msg.history-msg .msg-bubble { opacity: 0.75; }
    .msg-bubble pre { margin: 8px 0; border-radius: 8px; overflow-x: auto; }
    .msg-bubble code:not(pre code) { background: #1a1f26; padding: 1px 5px; border-radius: 4px; font-size: 0.85em; color: var(--orange); }
    .msg-bubble p { margin-bottom: 8px; }
    .msg-bubble p:last-child { margin-bottom: 0; }
    .msg-bubble ul, .msg-bubble ol { padding-left: 20px; margin-bottom: 8px; }
    .msg-bubble h1,.msg-bubble h2,.msg-bubble h3 { color: var(--accent); margin: 10px 0 6px; }
    .msg-bubble a { color: var(--blue); }
    .msg-bubble table { border-collapse: collapse; width: 100%; margin: 8px 0; }
    .msg-bubble th,.msg-bubble td { border: 1px solid var(--border); padding: 6px 12px; text-align: left; }
    .msg-bubble th { background: var(--bg); color: var(--accent); }
    .action-pill { display: inline-block; background: #1e3a2f; color: var(--green); font-size: 0.72rem; padding: 2px 8px; border-radius: 10px; margin: 2px; }
    .thinking { color: var(--muted); font-style: italic; font-size: 0.85rem; }
    .cursor { display: inline-block; width: 2px; height: 14px; background: var(--accent); animation: blink 0.8s infinite; vertical-align: middle; margin-left: 2px; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
    .history-divider { text-align: center; color: var(--muted); font-size: 0.72rem; padding: 8px 0; border-bottom: 1px solid var(--border); margin-bottom: 8px; }

    /* â”€â”€ Input area â”€â”€ */
    #input-area { background: var(--surface); border-top: 1px solid var(--border); padding: 10px 14px; display: flex; flex-direction: column; gap: 8px; }
    #input-row { display: flex; gap: 8px; align-items: flex-end; }
    #msg-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; color: var(--text); padding: 10px 14px; font-size: 0.92rem; font-family: inherit; resize: none; max-height: 120px; line-height: 1.5; transition: border-color .2s; }
    #msg-input:focus { outline: none; border-color: var(--accent); }
    #msg-input::placeholder { color: var(--muted); }
    #send-btn { background: var(--accent); color: #fff; border: none; border-radius: 10px; padding: 10px 18px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: opacity .2s; white-space: nowrap; }
    #send-btn:hover { opacity: .85; }
    #send-btn:disabled { opacity: .4; cursor: default; }
    #attach-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); border-radius: 10px; padding: 10px 12px; cursor: pointer; font-size: 1rem; transition: all .2s; line-height: 1; }
    #attach-btn:hover { border-color: var(--accent); color: var(--accent); }
    #file-input { display: none; }

    /* â”€â”€ Upload progress bar â”€â”€ */
    #upload-bar { display: none; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 0.8rem; color: var(--muted); align-items: center; gap: 10px; }
    #upload-bar.show { display: flex; }
    #upload-filename { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #upload-progress { height: 4px; background: var(--border); border-radius: 2px; flex: 1; overflow: hidden; }
    #upload-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width .3s; }

    /* â”€â”€ Right sidebar â”€â”€ */
    #sidebar { width: 280px; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
    .sidebar-section { border-bottom: 1px solid var(--border); }
    .sidebar-header { padding: 9px 14px; font-size: 0.7rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; cursor: pointer; display: flex; justify-content: space-between; user-select: none; }
    .sidebar-content { padding: 8px 14px 10px; }
    .stat-row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 0.8rem; }
    .stat-label { color: var(--muted); }
    .stat-value { font-weight: 600; }
    .task-item { padding: 5px 0; border-bottom: 1px solid #1c2128; font-size: 0.8rem; }
    .task-item:last-child { border: none; }
    .task-priority { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; padding: 1px 5px; border-radius: 8px; margin-right: 5px; }
    .priority-urgent { background: #3d1a1a; color: var(--red); }
    .priority-high { background: #3d2e0a; color: var(--yellow); }
    .priority-normal { background: #1c2128; color: var(--muted); }
    .priority-low { background: #111; color: #555; }

    /* â”€â”€ Graph â”€â”€ */
    #graph-svg { width: 100%; height: 175px; background: var(--bg); }
    .graph-node { cursor: pointer; }
    .node-concept { fill: #4c8ed4; } .node-entity { fill: #58a6ff; }
    .node-preference { fill: #3fb950; } .node-fact { fill: #d29922; }
    .node-technology { fill: #79c0ff; } .node-mistake { fill: #f85149; }
    .node-person { fill: #e8b428; } .node-question { fill: var(--muted); }
    .node-file { fill: #c678dd; } .node-skill { fill: #56d364; }
    .node-topic { fill: #b083f0; } .node-event { fill: #f08080; }
    .graph-link { stroke: var(--border); stroke-opacity: 0.5; }
    .empty-state { color: var(--muted); font-size: 0.8rem; text-align: center; padding: 14px 0; }

    /* â”€â”€ Ingest panel â”€â”€ */
    #ingest-area { display: flex; gap: 6px; }
    #ingest-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 6px 10px; font-size: 0.8rem; font-family: inherit; }
    #ingest-btn { background: #1e3a2f; color: var(--green); border: 1px solid #2d5a3f; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem; }
    #ingest-btn:hover { background: #2d4a3f; }

    /* â”€â”€ Toast â”€â”€ */
    #toast { position: fixed; bottom: 24px; right: 24px; background: #1c3a2f; border: 1px solid var(--green); color: var(--green); padding: 10px 18px; border-radius: 10px; font-size: 0.85rem; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 100; max-width: 340px; }
    #toast.show { opacity: 1; }

    /* â”€â”€ Drag-over overlay â”€â”€ */
    #drag-overlay { display: none; position: fixed; inset: 0; background: rgba(198,120,221,.12); border: 3px dashed var(--accent); z-index: 200; align-items: center; justify-content: center; font-size: 1.4rem; color: var(--accent); pointer-events: none; }
    #drag-overlay.active { display: flex; }

    @media (max-width: 900px) { #sidebar { display: none; } }
    @media (max-width: 650px) { #history-panel { display: none; } }

    /* â”€â”€ Graph Explorer Overlay â”€â”€ */
    #graph-explorer {
      display: none; position: fixed; inset: 0; z-index: 400;
      background: var(--bg); flex-direction: column;
    }
    #graph-explorer.active { display: flex; }
    #ge-topbar {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 10px 16px; display: flex; align-items: center; gap: 12px; flex-shrink: 0;
    }
    #ge-title { font-weight: 700; color: var(--accent); letter-spacing: 1px; }
    #ge-stats { font-size: .75rem; color: var(--muted); }
    #ge-close-btn { margin-left: auto; background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 5px 14px; font-size: .82rem; cursor: pointer; }
    #ge-close-btn:hover { border-color: var(--accent); color: var(--accent); }
    #ge-body { display: flex; flex: 1; overflow: hidden; }
    #ge-filters {
      width: 200px; background: var(--surface); border-right: 1px solid var(--border);
      padding: 14px 12px; overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; gap: 14px;
    }
    #ge-filters::-webkit-scrollbar { width: 4px; }
    #ge-filters::-webkit-scrollbar-thumb { background: var(--border); }
    .ge-filter-title { font-size: .68rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    #ge-search { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 6px 9px; font-size: .8rem; font-family: inherit; }
    #ge-search:focus { outline: none; border-color: var(--accent); }
    #ge-conf-label { font-size: .75rem; color: var(--muted); display: flex; justify-content: space-between; }
    #ge-conf-slider { width: 100%; accent-color: var(--accent); }
    .ge-type-check { display: flex; align-items: center; gap: 6px; font-size: .78rem; cursor: pointer; padding: 2px 0; }
    .ge-type-check input { accent-color: var(--accent); }
    .ge-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    #ge-center { flex: 1; position: relative; overflow: hidden; }
    #ge-svg { width: 100%; height: 100%; background: #0a0d12; display: block; }
    .ge-link { stroke: #30363d; stroke-opacity: .6; }
    .ge-node { cursor: pointer; }
    .ge-label { font-size: 9px; fill: rgba(230,237,243,.6); pointer-events: none; }
    #ge-detail {
      width: 260px; background: var(--surface); border-left: 1px solid var(--border);
      padding: 14px 13px; overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px;
    }
    #ge-detail::-webkit-scrollbar { width: 4px; }
    #ge-detail::-webkit-scrollbar-thumb { background: var(--border); }
    .ge-detail-title { font-size: .68rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .ge-detail-label { font-size: 1rem; font-weight: 700; word-break: break-word; color: var(--text); }
    .ge-kv { display: flex; gap: 6px; font-size: .78rem; }
    .ge-key { color: var(--muted); flex-shrink: 0; min-width: 70px; }
    .ge-val { color: var(--text); word-break: break-all; }
    .ge-edge-item { font-size: .75rem; padding: 4px 6px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface2); }
    .ge-edge-dir { font-size: .65rem; color: var(--muted); }
    #ge-delete-btn { background: rgba(248,81,73,.1); border: 1px solid rgba(248,81,73,.4); color: var(--red); border-radius: 8px; padding: 7px 14px; font-size: .82rem; cursor: pointer; transition: all .2s; }
    #ge-delete-btn:hover { background: rgba(248,81,73,.2); }
    .ge-empty { color: var(--muted); font-size: .82rem; text-align: center; padding: 20px 0; }

    /* â”€â”€ Image preview strip â”€â”€ */
    #img-preview-strip { display: none; padding: 6px 0 4px; gap: 8px; align-items: center; }
    #img-preview-strip.show { display: flex; }
    #img-preview-thumb { width: 52px; height: 52px; border-radius: 6px; object-fit: cover; border: 2px solid var(--accent); }
    #img-preview-name { font-size: .78rem; color: var(--muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #img-preview-remove { background: rgba(248,81,73,.1); border: 1px solid rgba(248,81,73,.3); color: var(--red); border-radius: 6px; padding: 3px 10px; font-size: .75rem; cursor: pointer; }
    #img-preview-remove:hover { background: rgba(248,81,73,.2); }
    .msg-image { max-width: 220px; max-height: 160px; border-radius: 8px; margin-bottom: 6px; display: block; border: 1px solid var(--border); }

    /* â”€â”€ Web search badge â”€â”€ */
    .search-badge { display: inline-flex; align-items: center; gap: 4px; background: #0d2034; border: 1px solid #1a4060; color: var(--blue); font-size: .68rem; padding: 2px 8px; border-radius: 10px; margin-top: 6px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VOICE MODE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #voice-overlay {
      display: none;
      position: fixed; inset: 0; z-index: 500;
      background: radial-gradient(ellipse at center, #0e0716 0%, #07050f 100%);
      flex-direction: column; align-items: center; justify-content: center;
      gap: 0;
    }
    #voice-overlay.active { display: flex; }

    /* Top bar */
    #voice-topbar {
      position: absolute; top: 0; left: 0; right: 0;
      padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;
    }
    #voice-title { color: rgba(255,255,255,.45); font-size: .78rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }
    #voice-provider-badge { font-size: .65rem; background: rgba(255,255,255,.06); color: rgba(255,255,255,.35); padding: 2px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,.08); }
    #voice-close-btn { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.1); color: rgba(255,255,255,.5); border-radius: 8px; padding: 6px 14px; cursor: pointer; font-size: .8rem; transition: all .2s; }
    #voice-close-btn:hover { background: rgba(248,81,73,.15); border-color: var(--red); color: var(--red); }

    /* Blob canvas */
    #voice-blob-wrap {
      position: relative; display: flex; align-items: center; justify-content: center;
      width: 320px; height: 320px; flex-shrink: 0;
    }
    #blob-canvas { position: absolute; inset: 0; width: 100%; height: 100%; }

    /* Pulse rings for listening state */
    .pulse-ring {
      position: absolute; border-radius: 50%;
      border: 1.5px solid rgba(34, 211, 238, .25);
      animation: ring-expand 2s ease-out infinite;
      pointer-events: none;
    }
    .pulse-ring:nth-child(2) { animation-delay: .6s; }
    .pulse-ring:nth-child(3) { animation-delay: 1.2s; }
    @keyframes ring-expand {
      0%   { width: 160px; height: 160px; opacity: .7; }
      100% { width: 310px; height: 310px; opacity: 0; }
    }
    #pulse-rings { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity .4s; }
    #pulse-rings.active { opacity: 1; }

    /* Status + transcript */
    #voice-status {
      font-size: .8rem; font-weight: 700; letter-spacing: 3px; text-transform: uppercase;
      margin-top: 8px; height: 20px;
      transition: color .4s;
    }
    #voice-transcript-wrap {
      width: min(480px, 90vw); min-height: 60px; max-height: 120px;
      overflow-y: auto; margin-top: 14px; padding: 0 12px;
      text-align: center;
    }
    #voice-transcript-wrap::-webkit-scrollbar { display: none; }
    #voice-user-text {
      font-size: .92rem; color: rgba(88,166,255,.75); line-height: 1.5;
      min-height: 24px; margin-bottom: 6px; font-style: italic;
    }
    #voice-agent-text {
      font-size: .9rem; color: rgba(230,237,243,.65); line-height: 1.5;
    }

    /* Controls */
    #voice-controls { display: flex; align-items: center; gap: 28px; margin-top: 32px; }
    #voice-mic-btn {
      width: 72px; height: 72px; border-radius: 50%;
      background: rgba(255,255,255,.06);
      border: 2px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.7); font-size: 1.6rem;
      cursor: pointer; transition: all .25s; display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    #voice-mic-btn:hover { background: rgba(255,255,255,.1); border-color: rgba(255,255,255,.3); }
    #voice-mic-btn.listening {
      background: rgba(34,211,238,.12);
      border-color: #22d3ee;
      box-shadow: 0 0 28px rgba(34,211,238,.3);
      animation: mic-pulse 1.4s ease-in-out infinite;
    }
    #voice-mic-btn.disabled { opacity: .3; cursor: not-allowed; }
    @keyframes mic-pulse { 0%,100%{box-shadow:0 0 28px rgba(34,211,238,.3)} 50%{box-shadow:0 0 50px rgba(34,211,238,.6)} }
    #voice-end-btn {
      width: 52px; height: 52px; border-radius: 50%;
      background: rgba(248,81,73,.12); border: 2px solid rgba(248,81,73,.3);
      color: var(--red); font-size: 1.1rem;
      cursor: pointer; transition: all .25s; display: flex; align-items: center; justify-content: center;
    }
    #voice-end-btn:hover { background: rgba(248,81,73,.25); box-shadow: 0 0 20px rgba(248,81,73,.3); }
    #voice-stt-unsupported { color: var(--red); font-size: .8rem; display: none; text-align: center; }
  </style>
</head>
<body>

<div id="drag-overlay">Drop file to ingest</div>

<div id="header">
  <div id="status-dot"></div>
  <div id="logo">PSYCHOPORTAL</div>
  <span class="badge" id="model-badge">connectingâ€¦</span>
  <span class="badge domain" id="domain-badge">general</span>
  <div id="header-right">
    <span class="badge" id="session-badge">â€”</span>
    <button class="hdr-btn" id="toggle-history-btn" title="Toggle session history">â˜° History</button>
    <button class="hdr-btn" id="graph-explorer-btn" title="Open Knowledge Graph Explorer" style="border-color:#1a4060;color:var(--blue);">ğŸ—º Graph</button>
    <button class="hdr-btn" onclick="openPersonalityPanel()" title="TARS-style personality calibration" style="border-color:#4a3060;color:#b083f0;">âš™ Personality</button>
    <button class="hdr-btn notif-bell" id="notif-btn" onclick="toggleNotifModal()" title="Notifications">ğŸ””<span class="notif-count hidden" id="notif-count">0</span></button>
    <button class="hdr-btn" id="voice-open-btn" title="Open voice mode" style="border-color:#4a3080;color:#b083f0;">ğŸ¤ Voice</button>
    <button class="hdr-btn primary" id="new-conv-btn">+ New Chat</button>
  </div>
</div>

<div id="main">
  <!-- â”€â”€ Session History (left sidebar) â”€â”€ -->
  <div id="history-panel">
    <div id="history-inner">
      <div id="history-header">
        Sessions
        <span id="sessions-count" style="color:var(--muted);font-weight:400">0</span>
      </div>
      <div id="sessions-list">
        <div class="empty-state">No sessions yet</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Chat panel â”€â”€ -->
  <div id="chat-panel">
    <div id="messages">
      <div class="msg agent" id="welcome-msg">
        <div class="msg-label">PSYCHOPORTAL</div>
        <div class="msg-bubble">
          <p>Hello! I'm your <strong>self-evolving AI assistant</strong>.</p>
          <p>I build a persistent knowledge graph from our conversations and remember everything across sessions.</p>
          <p style="color:var(--muted);font-size:.84rem">Upload files with the ğŸ“ button, paste text in the sidebar, or just start chatting!</p>
        </div>
      </div>
    </div>
    <div id="input-area">
      <div id="upload-bar">
        <span id="upload-filename">filename.pdf</span>
        <div id="upload-progress"><div id="upload-fill" style="width:0%"></div></div>
        <span id="upload-status" style="white-space:nowrap">Uploadingâ€¦</span>
      </div>
      <!-- Image preview (visible when image is pasted/dropped into chat) -->
      <div id="img-preview-strip">
        <img id="img-preview-thumb" src="" alt="preview" />
        <span id="img-preview-name">image</span>
        <button id="img-preview-remove">âœ• Remove</button>
      </div>
      <div id="input-row">
        <input type="file" id="file-input" accept=".txt,.md,.rst,.py,.js,.ts,.jsx,.tsx,.go,.rs,.java,.cpp,.c,.h,.cs,.rb,.php,.swift,.kt,.sh,.json,.yaml,.yml,.toml,.csv,.xml,.pdf,.png,.jpg,.jpeg,.gif,.webp" />
        <button id="attach-btn" title="Upload file (PDF, code, images, textâ€¦) or paste image with Ctrl+V">ğŸ“</button>
        <textarea id="msg-input" rows="1" placeholder="Type a messageâ€¦ (Enter to send) â€” paste or drop an image to chat with vision"></textarea>
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Right sidebar â”€â”€ -->
  <div id="sidebar">
    <!-- Stats -->
    <div class="sidebar-section">
      <div class="sidebar-header" onclick="toggleSection('stats-body')">STATS <span>â–¾</span></div>
      <div class="sidebar-content" id="stats-body">
        <div class="stat-row"><span class="stat-label">Sessions</span><span class="stat-value" id="s-sessions">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Messages</span><span class="stat-value" id="s-messages">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Graph nodes</span><span class="stat-value" id="s-nodes">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Graph edges</span><span class="stat-value" id="s-edges">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Avg confidence</span><span class="stat-value" id="s-conf">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Pending tasks</span><span class="stat-value" id="s-tasks">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Health entries</span><span class="stat-value" id="s-health">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Mistakes logged</span><span class="stat-value" id="s-mistakes">â€”</span></div>
        <div class="stat-row"><span class="stat-label">Model</span><span class="stat-value" id="s-model" style="font-size:.7rem">â€”</span></div>
      </div>
    </div>

    <!-- Tasks -->
    <div class="sidebar-section">
      <div class="sidebar-header" onclick="toggleSection('tasks-body')">TASKS <span>â–¾</span></div>
      <div class="sidebar-content" id="tasks-body">
        <div id="tasks-list"><div class="empty-state">No pending tasks</div></div>
      </div>
    </div>

    <!-- Knowledge Graph -->
    <div class="sidebar-section" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="sidebar-header" onclick="toggleSection('graph-body')">KNOWLEDGE GRAPH <span>â–¾</span></div>
      <div id="graph-body" style="flex:1;overflow:hidden;">
        <svg id="graph-svg"></svg>
        <div class="sidebar-content" style="padding-top:4px;">
          <div id="graph-legend" style="display:flex;flex-wrap:wrap;gap:4px;font-size:.65rem;"></div>
        </div>
      </div>
    </div>

    <!-- Ingest text -->
    <div class="sidebar-section">
      <div class="sidebar-header">INGEST TEXT</div>
      <div class="sidebar-content">
        <div id="ingest-area">
          <input id="ingest-input" placeholder="Paste text to add to graphâ€¦" />
          <button id="ingest-btn">Add</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GRAPH EXPLORER OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="graph-explorer">
  <div id="ge-topbar">
    <span id="ge-title">KNOWLEDGE GRAPH</span>
    <span id="ge-stats">0 nodes Â· 0 edges</span>
    <button id="ge-close-btn">âœ• Close</button>
  </div>
  <div id="ge-body">
    <!-- Filters panel -->
    <div id="ge-filters">
      <div>
        <div class="ge-filter-title">Search</div>
        <input id="ge-search" type="text" placeholder="Filter nodesâ€¦" />
      </div>
      <div>
        <div class="ge-filter-title">Min confidence</div>
        <div id="ge-conf-label"><span>0</span><span id="ge-conf-val">0.0</span></div>
        <input id="ge-conf-slider" type="range" min="0" max="100" value="0" />
      </div>
      <div>
        <div class="ge-filter-title">Node types</div>
        <div id="ge-type-filters"></div>
      </div>
    </div>

    <!-- Graph SVG -->
    <div id="ge-center">
      <svg id="ge-svg"></svg>
    </div>

    <!-- Detail panel -->
    <div id="ge-detail">
      <div class="ge-empty">Click a node to see details</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VOICE MODE OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="voice-overlay">
  <div id="voice-topbar">
    <span id="voice-title">Voice Mode</span>
    <span id="voice-provider-badge">browser tts</span>
    <button id="voice-close-btn">âœ• End Call</button>
  </div>

  <div id="voice-blob-wrap">
    <div id="pulse-rings">
      <div class="pulse-ring"></div>
      <div class="pulse-ring"></div>
      <div class="pulse-ring"></div>
    </div>
    <canvas id="blob-canvas"></canvas>
  </div>

  <div id="voice-status" style="color:rgba(255,255,255,.35)">READY</div>

  <div id="voice-transcript-wrap">
    <div id="voice-user-text"></div>
    <div id="voice-agent-text"></div>
  </div>

  <p id="voice-stt-unsupported">âš  Speech recognition not supported in this browser.<br>Use Chrome or Edge for voice input.</p>

  <div id="voice-controls">
    <button id="voice-end-btn" title="End call">ğŸ“µ</button>
    <button id="voice-mic-btn" title="Tap to speak">ğŸ¤</button>
  </div>
</div>

<div id="toast"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE = window.location.origin;
const WS_URL = `${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws/chat`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws = null;
let wsReady = false;
let currentStreamDiv = null;
let currentStreamContent = '';
let currentSessionId = null;
let viewingHistorySession = null; // null = live, string = viewing a past session

// â”€â”€ Markdown renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
marked.setOptions({ breaks: true, gfm: true });
function renderMd(text) {
  const html = marked.parse(text || '');
  const div = document.createElement('div');
  div.innerHTML = html;
  div.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
  return div.innerHTML;
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connect() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    wsReady = true;
    document.getElementById('status-dot').style.background = 'var(--green)';
    loadStats();
    loadTasks();
    loadGraph();
    loadSessions();
  };
  ws.onclose = () => {
    wsReady = false;
    document.getElementById('status-dot').style.background = 'var(--red)';
    setTimeout(connect, 3000);
  };
  ws.onerror = () => ws.close();
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'token') handleToken(data.token);
    else if (data.type === 'done') (window.handleDone || handleDone)(data);
    else if (data.type === 'error') handleError(data.message);
  };
}

function handleToken(token) {
  if (!currentStreamDiv) {
    currentStreamDiv = addMessage('agent', '', true);
  }
  currentStreamContent += token;
  currentStreamDiv.querySelector('.msg-bubble').innerHTML =
    renderMd(currentStreamContent) + '<span class="cursor"></span>';
  scrollBottom();
}

function handleDone(data) {
  if (currentStreamDiv) {
    currentStreamDiv.querySelector('.msg-bubble').innerHTML = renderMd(currentStreamContent);
    if (data.actions && data.actions.length > 0) {
      const actDiv = document.createElement('div');
      actDiv.style.marginTop = '6px';
      data.actions.forEach(a => {
        const pill = document.createElement('span');
        pill.className = 'action-pill';
        pill.textContent = a;
        actDiv.appendChild(pill);
      });
      currentStreamDiv.querySelector('.msg-bubble').appendChild(actDiv);
    }
    currentStreamDiv = null;
    currentStreamContent = '';
  }
  if (data.domain) document.getElementById('domain-badge').textContent = data.domain;
  if (data.session_id) {
    currentSessionId = data.session_id;
    document.getElementById('session-badge').textContent = 'session: ' + data.session_id;
  }
  document.getElementById('send-btn').disabled = false;
  scrollBottom();
  setTimeout(() => { loadStats(); loadTasks(); loadGraph(); loadSessions(); }, 600);
}

function handleError(msg) {
  if (currentStreamDiv) {
    currentStreamDiv.querySelector('.msg-bubble').innerHTML =
      `<span style="color:var(--red)">Error: ${escHtml(msg)}</span>`;
    currentStreamDiv = null;
    currentStreamContent = '';
  }
  document.getElementById('send-btn').disabled = false;
  showToast('Error: ' + msg, 'red');
}

// â”€â”€ Sending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || !wsReady) return;

  // If viewing history, switch back to live first
  if (viewingHistorySession) switchToLive();

  addMessage('user', text);
  input.value = '';
  input.style.height = 'auto';
  document.getElementById('send-btn').disabled = true;
  ws.send(JSON.stringify({ type: 'chat', message: text }));
  scrollBottom();
}

document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('msg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
document.getElementById('msg-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// â”€â”€ New conversation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('new-conv-btn').addEventListener('click', () => {
  switchToLive();
  clearMessages();
  showToast('New conversation started. Memory and knowledge graph are preserved.');
});

function switchToLive() {
  viewingHistorySession = null;
  // Re-mark current session as active
  document.querySelectorAll('.session-item').forEach(el => {
    el.classList.toggle('active', el.dataset.sessionId === currentSessionId);
  });
}

function clearMessages() {
  const container = document.getElementById('messages');
  container.innerHTML = `
    <div class="msg agent">
      <div class="msg-label">PSYCHOPORTAL</div>
      <div class="msg-bubble">
        <p>New conversation. I still have all my memories â€” what would you like to talk about?</p>
      </div>
    </div>`;
}

// â”€â”€ Message rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMessage(role, content, streaming = false, extraClass = '') {
  const container = document.getElementById('messages');
  const msgDiv = document.createElement('div');
  msgDiv.className = `msg ${role}${extraClass ? ' ' + extraClass : ''}`;
  const labelText = role === 'user' ? 'YOU' : 'PSYCHOPORTAL';
  msgDiv.innerHTML = `
    <div class="msg-label">${labelText}</div>
    <div class="msg-bubble">${streaming ? '<span class="thinking">thinkingâ€¦</span>' : renderMd(content)}</div>
  `;
  container.appendChild(msgDiv);
  scrollBottom();
  return msgDiv;
}

function scrollBottom() {
  const m = document.getElementById('messages');
  m.scrollTop = m.scrollHeight;
}

// â”€â”€ Session history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSessions() {
  try {
    const r = await fetch(`${BASE}/api/sessions?limit=40`);
    const d = await r.json();
    renderSessions(d.sessions || []);
  } catch (e) {}
}

function renderSessions(sessions) {
  const list = document.getElementById('sessions-list');
  document.getElementById('sessions-count').textContent = sessions.length;

  if (sessions.length === 0) {
    list.innerHTML = '<div class="empty-state">No sessions yet</div>';
    return;
  }

  list.innerHTML = sessions.map((s, i) => {
    const date = new Date(s.started_at * 1000);
    const dateStr = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const isCurrent = s.id === currentSessionId;
    const count = s.message_count || 0;
    return `
      <div class="session-item${isCurrent ? ' active' : ''}" data-session-id="${s.id}" onclick="loadSessionHistory('${s.id}')">
        <div class="session-label">${dateStr} ${timeStr}${isCurrent ? '<span class="current-tag">live</span>' : ''}</div>
        <div class="session-count">${count} message${count !== 1 ? 's' : ''}</div>
      </div>`;
  }).join('');
}

async function loadSessionHistory(sessionId) {
  // Mark active
  document.querySelectorAll('.session-item').forEach(el => {
    el.classList.toggle('active', el.dataset.sessionId === sessionId);
  });

  if (sessionId === currentSessionId) {
    switchToLive();
    return;
  }

  viewingHistorySession = sessionId;

  try {
    const r = await fetch(`${BASE}/api/sessions/${sessionId}/messages`);
    const d = await r.json();
    const messages = d.messages || [];

    const container = document.getElementById('messages');
    container.innerHTML = '';

    if (messages.length === 0) {
      container.innerHTML = '<div class="empty-state" style="margin-top:40px">No messages in this session</div>';
      return;
    }

    const date = new Date(messages[0].timestamp * 1000).toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    const divider = document.createElement('div');
    divider.className = 'history-divider';
    divider.textContent = `â€” Session from ${date} â€”`;
    container.appendChild(divider);

    messages.forEach(m => {
      addMessage('user', m.user_message, false, 'history-msg');
      addMessage('agent', m.agent_response, false, 'history-msg');
    });

    const note = document.createElement('div');
    note.className = 'history-divider';
    note.innerHTML = 'Viewing history &mdash; <a href="#" onclick="switchToLive();return false;" style="color:var(--accent)">return to live chat</a>';
    container.appendChild(note);
    scrollBottom();
  } catch (e) {
    showToast('Failed to load session history', 'red');
  }
}

// Toggle history panel
document.getElementById('toggle-history-btn').addEventListener('click', () => {
  document.getElementById('history-panel').classList.toggle('collapsed');
});

// â”€â”€ File upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('attach-btn').addEventListener('click', () => {
  document.getElementById('file-input').click();
});

document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) uploadFile(file);
  e.target.value = ''; // reset so same file can be uploaded again
});

// Drag and drop anywhere on the page
document.addEventListener('dragover', e => {
  e.preventDefault();
  document.getElementById('drag-overlay').classList.add('active');
});
document.addEventListener('dragleave', e => {
  if (!e.relatedTarget) document.getElementById('drag-overlay').classList.remove('active');
});
document.addEventListener('drop', e => {
  e.preventDefault();
  document.getElementById('drag-overlay').classList.remove('active');
  const file = e.dataTransfer.files[0];
  if (file) uploadFile(file);
});

async function uploadFile(file) {
  const bar = document.getElementById('upload-bar');
  const fill = document.getElementById('upload-fill');
  const status = document.getElementById('upload-status');
  const fname = document.getElementById('upload-filename');

  fname.textContent = file.name;
  fill.style.width = '0%';
  status.textContent = 'Uploadingâ€¦';
  bar.classList.add('show');

  // Fake progress animation while waiting
  let prog = 0;
  const progInterval = setInterval(() => {
    prog = Math.min(prog + 8, 85);
    fill.style.width = prog + '%';
  }, 200);

  const formData = new FormData();
  formData.append('file', file);

  try {
    const r = await fetch(`${BASE}/api/upload`, { method: 'POST', body: formData });
    clearInterval(progInterval);
    fill.style.width = '100%';

    if (!r.ok) {
      const err = await r.json();
      status.textContent = 'Failed';
      bar.style.borderColor = 'var(--red)';
      showToast(err.error || 'Upload failed', 'red');
      setTimeout(() => { bar.classList.remove('show'); bar.style.borderColor = ''; }, 3000);
      return;
    }

    const d = await r.json();
    status.textContent = 'Done!';

    // Add a system message in chat
    const container = document.getElementById('messages');
    const sysmsg = document.createElement('div');
    sysmsg.style.cssText = 'text-align:center;padding:8px 0;';
    const errs = d.errors && d.errors.length > 0 ? ` (${d.errors.join(', ')})` : '';
    sysmsg.innerHTML = `<span style="background:#1e1a2f;border:1px solid #4a3080;color:#b083f0;font-size:.75rem;padding:4px 12px;border-radius:10px;">
      ğŸ“ <strong>${escHtml(file.name)}</strong> ingested â€” +${d.nodes_added} nodes, +${d.facts_added} facts${errs}
    </span>`;
    container.appendChild(sysmsg);
    scrollBottom();

    showToast(`${file.name}: +${d.nodes_added} nodes, +${d.facts_added} facts`);
    setTimeout(() => { loadStats(); loadGraph(); }, 800);
    setTimeout(() => { bar.classList.remove('show'); }, 2000);
  } catch (e) {
    clearInterval(progInterval);
    status.textContent = 'Error';
    showToast('Upload error: ' + e.message, 'red');
    setTimeout(() => bar.classList.remove('show'), 3000);
  }
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const r = await fetch(`${BASE}/api/stats`);
    const s = await r.json();
    document.getElementById('s-sessions').textContent = s.sessions || 0;
    document.getElementById('s-messages').textContent = s.interactions || 0;
    document.getElementById('s-nodes').textContent = s.graph_nodes || 0;
    document.getElementById('s-edges').textContent = s.graph_edges || 0;
    document.getElementById('s-conf').textContent = s.graph_avg_confidence ? s.graph_avg_confidence.toFixed(2) : 'â€”';
    document.getElementById('s-tasks').textContent = s.pending_tasks || 0;
    document.getElementById('s-health').textContent = s.health_entries || 0;
    document.getElementById('s-mistakes').textContent = s.total_mistakes || 0;
    document.getElementById('s-model').textContent = s.model || 'â€”';
    document.getElementById('model-badge').textContent = s.model || 'â€”';
    if (s.session_id && !currentSessionId) {
      currentSessionId = s.session_id;
      document.getElementById('session-badge').textContent = 'session: ' + s.session_id;
    }
  } catch (e) {}
}

// â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTasks() {
  try {
    const r = await fetch(`${BASE}/api/tasks`);
    const d = await r.json();
    const list = document.getElementById('tasks-list');
    if (!d.tasks || d.tasks.length === 0) {
      list.innerHTML = '<div class="empty-state">No pending tasks</div>';
      return;
    }
    list.innerHTML = d.tasks.slice(0, 8).map(t => `
      <div class="task-item">
        <span class="task-priority priority-${t.priority}">${t.priority}</span>
        ${escHtml(t.title.substring(0, 45))}
        ${t.due_date ? `<span style="color:var(--muted);font-size:.7rem"> Â· ${t.due_date}</span>` : ''}
      </div>
    `).join('');
  } catch (e) {}
}

// â”€â”€ Knowledge graph D3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let graphSimulation = null;

async function loadGraph() {
  try {
    const r = await fetch(`${BASE}/api/graph?limit=80`);
    const d = await r.json();
    renderGraph(d.nodes || [], d.links || []);
  } catch (e) {}
}

const nodeColorMap = {concept:'#4c8ed4',entity:'#58a6ff',preference:'#3fb950',fact:'#d29922',
  technology:'#79c0ff',mistake:'#f85149',person:'#e8b428',question:'#8b949e',
  file:'#c678dd',skill:'#56d364',topic:'#b083f0',event:'#f08080'};

function renderGraph(nodes, links) {
  const svg = d3.select('#graph-svg');
  svg.selectAll('*').remove();
  if (nodes.length === 0) return;

  const el = document.getElementById('graph-svg');
  const W = el.clientWidth || 260;
  const H = el.clientHeight || 175;

  const nodeMap = {};
  nodes.forEach(n => nodeMap[n.id] = n);
  const validLinks = links.filter(l => nodeMap[l.source] && nodeMap[l.target]);

  if (graphSimulation) graphSimulation.stop();
  graphSimulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(validLinks).id(d => d.id).distance(38))
    .force('charge', d3.forceManyBody().strength(-38))
    .force('center', d3.forceCenter(W / 2, H / 2))
    .force('collision', d3.forceCollide(7));

  const g = svg.append('g');
  const link = g.append('g').selectAll('line').data(validLinks)
    .join('line').attr('class', 'graph-link').attr('stroke-width', 1);

  const node = g.append('g').selectAll('circle').data(nodes)
    .join('circle')
    .attr('class', 'graph-node')
    .attr('r', d => 3 + d.confidence * 5)
    .attr('fill', d => nodeColorMap[d.type] || '#8b949e')
    .attr('opacity', 0.85)
    .call(d3.drag()
      .on('start', (ev, d) => { if (!ev.active) graphSimulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on('drag', (ev, d) => { d.fx = ev.x; d.fy = ev.y; })
      .on('end', (ev, d) => { if (!ev.active) graphSimulation.alphaTarget(0); d.fx = null; d.fy = null; })
    );

  node.append('title').text(d => `${d.label} (${d.type}, ${d.confidence.toFixed(2)})`);
  graphSimulation.on('tick', () => {
    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    node.attr('cx', d => Math.max(5, Math.min(W-5, d.x)))
        .attr('cy', d => Math.max(5, Math.min(H-5, d.y)));
  });
  svg.call(d3.zoom().scaleExtent([0.3, 3]).on('zoom', ev => g.attr('transform', ev.transform)));

  const types = [...new Set(nodes.map(n => n.type))].slice(0, 6);
  document.getElementById('graph-legend').innerHTML = types.map(t =>
    `<span style="color:${nodeColorMap[t]||'#8b949e'};font-size:.62rem">â— ${t}</span>`
  ).join(' ');
}

// â”€â”€ Ingest text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('ingest-btn').addEventListener('click', async () => {
  const input = document.getElementById('ingest-input');
  const text = input.value.trim();
  if (!text) return;
  try {
    const r = await fetch(`${BASE}/api/ingest`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ text, source_name: 'web_ui', domain: 'general' }),
    });
    const d = await r.json();
    input.value = '';
    showToast(`Ingested: +${d.nodes_added} nodes, +${d.facts_added} facts`);
    setTimeout(() => { loadStats(); loadGraph(); }, 800);
  } catch (e) { showToast('Ingest failed', 'red'); }
});

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSection(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = el.style.display === 'none' ? '' : 'none';
}

function showToast(msg, color = 'green') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = color === 'red' ? '#3d1a1a' : '#1c3a2f';
  t.style.borderColor = color === 'red' ? 'var(--red)' : 'var(--green)';
  t.style.color = color === 'red' ? 'var(--red)' : 'var(--green)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Blob Animator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class VoiceBlob {
  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.N = 12;           // control points
    this.t = 0;            // time counter
    this.state = 'idle';   // idle | listening | thinking | speaking
    this.amp = 0;          // 0â€“1, smoothed audio amplitude
    this.targetAmp = 0;
    this._raf = null;

    // Per-point phase offsets for organic feel
    this.phases = Array.from({length: this.N}, () => Math.random() * Math.PI * 2);

    // Color lerp state (current â†’ target)
    this._colorFrom = [108, 40, 180];  // idle purple
    this._colorTo   = [108, 40, 180];
    this._colorT = 1;
    this._colorDur = 0.4;

    this._resize();
    window.addEventListener('resize', () => this._resize());
  }

  _resize() {
    const wrap = this.canvas.parentElement;
    const size = Math.min(wrap.offsetWidth, wrap.offsetHeight);
    this.canvas.width  = size;
    this.canvas.height = size;
    this.CX = size / 2;
    this.CY = size / 2;
    this.BASE_R = size * 0.30;
  }

  setState(state) {
    if (this.state === state) return;
    this.state = state;

    // Color targets per state
    const colors = {
      idle:      [108, 40, 180],
      listening: [8,  145, 178],
      thinking:  [180, 100, 10],
      speaking:  [168, 30, 120],
    };
    this._colorFrom = this._getCurrentColor();
    this._colorTo   = colors[state] || colors.idle;
    this._colorT = 0;
  }

  _getCurrentColor() {
    const t = Math.min(this._colorT, 1);
    return this._colorFrom.map((a, i) => Math.round(a + (this._colorTo[i] - a) * t));
  }

  setAmplitude(a) { this.targetAmp = Math.max(0, Math.min(1, a)); }

  _stateConfig() {
    const a = this.amp;
    switch (this.state) {
      case 'listening': return { wobble: 0.10, speed: 1.4, radScale: 1.05, extraFreq: 0 };
      case 'thinking':  return { wobble: 0.20, speed: 2.8, radScale: 1.02, extraFreq: 3 };
      case 'speaking':  return { wobble: 0.14 + a * 0.30, speed: 2.0, radScale: 1.04 + a * 0.12, extraFreq: 0 };
      default:          return { wobble: 0.05, speed: 0.5, radScale: 1.00, extraFreq: 0 };
    }
  }

  _draw() {
    const { canvas, ctx, CX, CY, BASE_R, N, phases, t } = this;
    const W = canvas.width, H = canvas.height;

    // Smooth amplitude
    this.amp += (this.targetAmp - this.amp) * 0.12;

    // Advance color lerp
    if (this._colorT < 1) this._colorT = Math.min(1, this._colorT + 0.025);

    const cfg  = this._stateConfig();
    const R    = BASE_R * cfg.radScale;
    const step = (Math.PI * 2) / N;

    // Build blob control points
    const pts = phases.map((ph, i) => {
      const base  = step * i - Math.PI / 2;
      const w1    = Math.sin(t * cfg.speed + ph) * cfg.wobble;
      const w2    = cfg.extraFreq
        ? Math.sin(t * cfg.extraFreq + ph * 1.7) * cfg.wobble * 0.5
        : 0;
      const wAmp  = this.state === 'speaking'
        ? Math.sin(t * 9 + i * 1.9) * this.amp * 0.20
        : 0;
      const r = R * (1 + w1 + w2 + wAmp);
      return { x: CX + Math.cos(base) * r, y: CY + Math.sin(base) * r };
    });

    ctx.clearRect(0, 0, W, H);

    // Draw smooth blob
    ctx.beginPath();
    for (let i = 0; i < N; i++) {
      const c = pts[i], nx = pts[(i + 1) % N];
      const mx = (c.x + nx.x) / 2, my = (c.y + nx.y) / 2;
      if (i === 0) ctx.moveTo(mx, my);
      ctx.quadraticCurveTo(c.x, c.y, mx, my);
    }
    ctx.closePath();

    // Radial gradient fill
    const col = this._getCurrentColor();
    const colStr  = `rgb(${col[0]},${col[1]},${col[2]})`;
    const colBright = `rgb(${Math.min(255,col[0]+70)},${Math.min(255,col[1]+50)},${Math.min(255,col[2]+80)})`;
    const grd = ctx.createRadialGradient(CX, CY - R * 0.2, 0, CX, CY, R * 1.35);
    grd.addColorStop(0, colBright);
    grd.addColorStop(1, colStr);
    ctx.fillStyle = grd;

    // Glow
    const glowAmt = 22 + this.amp * 55 + (this.state === 'speaking' ? 20 : 0);
    ctx.shadowColor  = colBright;
    ctx.shadowBlur   = glowAmt;
    ctx.fill();

    // Inner highlight (specular)
    ctx.shadowBlur = 0;
    const hgrd = ctx.createRadialGradient(CX - R * 0.3, CY - R * 0.35, 0, CX, CY, R * 0.8);
    hgrd.addColorStop(0, 'rgba(255,255,255,0.18)');
    hgrd.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = hgrd;
    ctx.fill();

    this.t += 0.016;
    this._raf = requestAnimationFrame(() => this._draw());
  }

  start() { if (!this._raf) this._draw(); }
  stop()  { if (this._raf) { cancelAnimationFrame(this._raf); this._raf = null; } }
}

// â”€â”€ TTS Engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class TTSEngine {
  constructor() {
    this.provider = 'browser';
    this.audioCtx = null;
    this.analyser = null;
    this._ampTimer = null;
    this.onAmplitude = () => {};  // callback(0-1)
    this.onStart = () => {};
    this.onEnd   = () => {};
  }

  async init() {
    try {
      const r = await fetch(`${BASE}/api/voice/config`);
      const d = await r.json();
      this.provider = d.provider;
      document.getElementById('voice-provider-badge').textContent = d.provider + ' tts';
    } catch { this.provider = 'browser'; }
  }

  async speak(text) {
    if (!text.trim()) return;
    window.speechSynthesis && window.speechSynthesis.cancel();

    if (this.provider !== 'browser') {
      const ok = await this._speakBackend(text);
      if (ok) return;
    }
    this._speakBrowser(text);
  }

  async _speakBackend(text) {
    try {
      const r = await fetch(`${BASE}/api/voice/tts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });
      if (r.status !== 200) return false;

      const arrayBuffer = await r.arrayBuffer();

      // Decode and play with amplitude analysis
      if (!this.audioCtx || this.audioCtx.state === 'closed') {
        this.audioCtx = new AudioContext();
      }
      if (this.audioCtx.state === 'suspended') await this.audioCtx.resume();

      const buffer = await this.audioCtx.decodeAudioData(arrayBuffer);
      const source  = this.audioCtx.createBufferSource();
      const analyser = this.audioCtx.createAnalyser();
      analyser.fftSize = 64;
      source.buffer = buffer;
      source.connect(analyser);
      analyser.connect(this.audioCtx.destination);

      this.onStart();
      const data = new Uint8Array(analyser.frequencyBinCount);
      let playing = true;

      const tick = () => {
        if (!playing) return;
        analyser.getByteFrequencyData(data);
        const avg = data.reduce((a, b) => a + b, 0) / data.length / 255;
        this.onAmplitude(avg);
        this._ampTimer = requestAnimationFrame(tick);
      };
      tick();

      source.onended = () => {
        playing = false;
        cancelAnimationFrame(this._ampTimer);
        this.onAmplitude(0);
        this.onEnd();
      };
      source.start();
      return true;
    } catch { return false; }
  }

  _speakBrowser(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate  = 1.0;
    utter.pitch = 1.0;

    // Simulate amplitude with fake speech rhythm
    let fakeT = 0;
    this.onStart();
    const tick = () => {
      fakeT += 0.08;
      const fakeAmp = 0.25 + Math.sin(fakeT * 6.3) * 0.12 + Math.sin(fakeT * 2.7) * 0.08;
      this.onAmplitude(Math.max(0, fakeAmp));
      this._ampTimer = requestAnimationFrame(tick);
    };
    tick();

    utter.onend = () => {
      cancelAnimationFrame(this._ampTimer);
      this.onAmplitude(0);
      this.onEnd();
    };
    window.speechSynthesis.speak(utter);
  }

  stop() {
    window.speechSynthesis && window.speechSynthesis.cancel();
    cancelAnimationFrame(this._ampTimer);
    this.onAmplitude(0);
  }
}

// â”€â”€ STT Engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class STTEngine {
  constructor() {
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    this.supported = !!SpeechRec;
    if (!this.supported) return;

    this.rec = new SpeechRec();
    this.rec.continuous  = false;
    this.rec.interimResults = true;
    this.rec.lang = 'en-US';
    this.active = false;

    this.onInterim = () => {};
    this.onFinal   = () => {};
    this.onEnd     = () => {};
    this.onError   = () => {};

    this.rec.onresult = (e) => {
      const parts = Array.from(e.results).map(r => r[0].transcript);
      const text  = parts.join('');
      const isFinal = e.results[e.results.length - 1].isFinal;
      if (isFinal) {
        this.onFinal(text);
      } else {
        this.onInterim(text);
      }
    };
    this.rec.onerror = (e) => { this.active = false; this.onError(e.error); };
    this.rec.onend   = ()  => { this.active = false; this.onEnd(); };
  }

  start() {
    if (!this.supported || this.active) return;
    try { this.rec.start(); this.active = true; } catch {}
  }

  stop() {
    if (!this.supported || !this.active) return;
    try { this.rec.stop(); } catch {}
  }
}

// â”€â”€ Voice Mode Controller â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const voiceBlob  = new VoiceBlob(document.getElementById('blob-canvas'));
const ttsEngine  = new TTSEngine();
const sttEngine  = new STTEngine();

let voiceOpen       = false;
let voiceState      = 'idle';   // idle | listening | thinking | speaking
let pendingResponse = '';       // agent response waiting for TTS
let autoListen      = false;    // re-listen after speaking

function setVoiceState(state) {
  voiceState = state;
  voiceBlob.setState(state);

  const statusEl = document.getElementById('voice-status');
  const micBtn   = document.getElementById('voice-mic-btn');
  const rings    = document.getElementById('pulse-rings');

  const labels = { idle: 'READY', listening: 'LISTENINGâ€¦', thinking: 'THINKINGâ€¦', speaking: 'SPEAKINGâ€¦' };
  const colors = { idle: 'rgba(255,255,255,.35)', listening: '#22d3ee', thinking: '#fbbf24', speaking: '#f472b6' };

  statusEl.textContent  = labels[state] || 'READY';
  statusEl.style.color  = colors[state] || colors.idle;
  rings.classList.toggle('active', state === 'listening');

  micBtn.classList.toggle('listening', state === 'listening');
  micBtn.classList.toggle('disabled',  state === 'thinking' || state === 'speaking');
}

function openVoiceMode() {
  voiceOpen = true;
  document.getElementById('voice-overlay').classList.add('active');
  voiceBlob.start();
  setVoiceState('idle');
  ttsEngine.init();
  document.getElementById('voice-user-text').textContent  = '';
  document.getElementById('voice-agent-text').textContent = '';

  if (!sttEngine.supported) {
    document.getElementById('voice-stt-unsupported').style.display = 'block';
  }
}

function closeVoiceMode() {
  voiceOpen = false;
  document.getElementById('voice-overlay').classList.remove('active');
  voiceBlob.stop();
  ttsEngine.stop();
  sttEngine.stop();
  setVoiceState('idle');
}

// Wire TTS callbacks
ttsEngine.onAmplitude = (a) => voiceBlob.setAmplitude(a);
ttsEngine.onStart     = ()  => setVoiceState('speaking');
ttsEngine.onEnd       = ()  => {
  setVoiceState('idle');
  // Auto-resume listening after agent finishes speaking
  if (voiceOpen && autoListen) {
    setTimeout(() => { if (voiceOpen && voiceState === 'idle') startListening(); }, 500);
  }
};

// Wire STT callbacks
sttEngine.onInterim = (text) => {
  document.getElementById('voice-user-text').textContent = text;
};
sttEngine.onFinal = (text) => {
  document.getElementById('voice-user-text').textContent = text;
  if (text.trim() && wsReady) {
    setVoiceState('thinking');
    document.getElementById('voice-agent-text').textContent = '';
    // Send via existing WebSocket â€” response comes back in handleDone
    ws.send(JSON.stringify({ type: 'chat', message: text }));
  }
};
sttEngine.onEnd = () => {
  if (voiceState === 'listening') setVoiceState('idle');
};
sttEngine.onError = (err) => {
  if (voiceState === 'listening') setVoiceState('idle');
};

function startListening() {
  if (!sttEngine.supported || voiceState === 'speaking' || voiceState === 'thinking') return;
  setVoiceState('listening');
  sttEngine.start();
}

function stopListening() {
  sttEngine.stop();
  if (voiceState === 'listening') setVoiceState('idle');
}

// Hook into existing WebSocket done handler to speak responses in voice mode
const _origHandleDone = handleDone;
window.handleDone = function(data) {
  _origHandleDone(data);
  if (voiceOpen && data.response) {
    // Strip markdown for cleaner speech
    const plain = data.response
      .replace(/```[\s\S]*?```/g, ' code block. ')
      .replace(/`([^`]+)`/g, '$1')
      .replace(/\*\*([^*]+)\*\*/g, '$1')
      .replace(/\*([^*]+)\*/g, '$1')
      .replace(/^#{1,6}\s+/gm, '')
      .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
      .replace(/\n{2,}/g, '. ')
      .replace(/\n/g, ' ')
      .trim();

    document.getElementById('voice-agent-text').textContent = data.response.substring(0, 180) + (data.response.length > 180 ? 'â€¦' : '');
    ttsEngine.speak(plain);
  }
};
// Reassign so existing code still calls our wrapped version
ws && (ws.onmessage = e => {
  const data = JSON.parse(e.data);
  if (data.type === 'token') handleToken(data.token);
  else if (data.type === 'done') window.handleDone(data);
  else if (data.type === 'error') handleError(data.message);
});

// Button wiring
document.getElementById('voice-open-btn').addEventListener('click', openVoiceMode);
document.getElementById('voice-close-btn').addEventListener('click', closeVoiceMode);
document.getElementById('voice-end-btn').addEventListener('click', closeVoiceMode);

document.getElementById('voice-mic-btn').addEventListener('click', () => {
  if (voiceState === 'listening') {
    autoListen = false;
    stopListening();
  } else if (voiceState === 'idle') {
    autoListen = true;
    startListening();
  }
});

// Keyboard: Space to toggle mic when voice mode is open
document.addEventListener('keydown', (e) => {
  if (!voiceOpen) return;
  if (e.code === 'Space' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
    e.preventDefault();
    if (voiceState === 'listening') { autoListen = false; stopListening(); }
    else if (voiceState === 'idle') { autoListen = true; startListening(); }
  }
  if (e.code === 'Escape') closeVoiceMode();
});

// Patch ws.onmessage after reconnect too
const _origConnect = connect;
window._patchWsVoice = function() {
  if (!ws) return;
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'token') handleToken(data.token);
    else if (data.type === 'done') window.handleDone(data);
    else if (data.type === 'error') handleError(data.message);
  };
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE D â€” IMAGE CHAT (paste / drop images into chat)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let pendingImage = null;  // { base64: string, mediaType: string, name: string }

function setPendingImage(base64, mediaType, name) {
  pendingImage = { base64, mediaType, name };
  const strip = document.getElementById('img-preview-strip');
  const thumb = document.getElementById('img-preview-thumb');
  const nameEl = document.getElementById('img-preview-name');
  thumb.src = `data:${mediaType};base64,${base64}`;
  nameEl.textContent = name || 'image';
  strip.classList.add('show');
}

function clearPendingImage() {
  pendingImage = null;
  document.getElementById('img-preview-strip').classList.remove('show');
  document.getElementById('img-preview-thumb').src = '';
}

document.getElementById('img-preview-remove').addEventListener('click', clearPendingImage);

// Paste image from clipboard
document.addEventListener('paste', (e) => {
  const items = e.clipboardData && e.clipboardData.items;
  if (!items) return;
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      const file = item.getAsFile();
      if (!file) continue;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const dataUrl = ev.target.result;
        const [header, base64] = dataUrl.split(',');
        const mediaType = header.match(/data:([^;]+)/)[1];
        setPendingImage(base64, mediaType, 'pasted-image');
      };
      reader.readAsDataURL(file);
      break;
    }
  }
});

// Drop image onto message input area
document.getElementById('input-area').addEventListener('drop', (e) => {
  const file = e.dataTransfer && e.dataTransfer.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  // Only intercept image drops here (non-image drops handled by page-level handler)
  e.stopPropagation();
  e.preventDefault();
  document.getElementById('drag-overlay').classList.remove('active');
  const reader = new FileReader();
  reader.onload = (ev) => {
    const [header, base64] = ev.target.result.split(',');
    const mediaType = header.match(/data:([^;]+)/)[1];
    setPendingImage(base64, mediaType, file.name);
  };
  reader.readAsDataURL(file);
}, true);

// Override sendMessage to handle image
const _origSendMessage = sendMessage;
window.sendMessage = function() {
  if (pendingImage && wsReady) {
    const input = document.getElementById('msg-input');
    const text = input.value.trim() || 'Describe and analyse this image.';

    if (viewingHistorySession) switchToLive();

    // Render user bubble with thumbnail
    const container = document.getElementById('messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg user';
    msgDiv.innerHTML = `
      <div class="msg-label">YOU</div>
      <div class="msg-bubble">
        <img src="data:${pendingImage.mediaType};base64,${pendingImage.base64}" class="msg-image" alt="attached image" />
        ${text !== 'Describe and analyse this image.' ? `<p>${escHtml(text)}</p>` : ''}
      </div>`;
    container.appendChild(msgDiv);
    scrollBottom();

    input.value = '';
    input.style.height = 'auto';
    document.getElementById('send-btn').disabled = true;

    ws.send(JSON.stringify({
      type: 'image_chat',
      message: text,
      image: pendingImage.base64,
      media_type: pendingImage.mediaType,
    }));

    clearPendingImage();
    return;
  }
  _origSendMessage();
};

// Re-wire send button to use our override (_origSendMessage is the old reference).
// The keydown listener already works because it calls the global `sendMessage`
// which now resolves to window.sendMessage (the new override) via scope-chain lookup.
document.getElementById('send-btn').removeEventListener('click', _origSendMessage);
document.getElementById('send-btn').addEventListener('click', window.sendMessage);

// Show web search badge when agent used web search
const _origHandleDone2 = window.handleDone;
window.handleDone = function(data) {
  _origHandleDone2(data);
  if (data.search_query && currentStreamDiv === null) {
    // Find the last agent message and append badge
    const msgs = document.getElementById('messages').querySelectorAll('.msg.agent');
    const last = msgs[msgs.length - 1];
    if (last) {
      const badge = document.createElement('div');
      badge.className = 'search-badge';
      badge.innerHTML = `ğŸ” web search: <em>${escHtml(data.search_query)}</em>`;
      last.querySelector('.msg-bubble').appendChild(badge);
    }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE A â€” KNOWLEDGE GRAPH EXPLORER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let explorerData = { nodes: [], links: [] };
let explorerSim  = null;
let explorerSelectedNode = null;
const GE_COLORS = {
  concept:'#4c8ed4',entity:'#58a6ff',preference:'#3fb950',fact:'#d29922',
  technology:'#79c0ff',mistake:'#f85149',person:'#e8b428',question:'#8b949e',
  file:'#c678dd',skill:'#56d364',topic:'#b083f0',event:'#f08080',
};

function openGraphExplorer() {
  document.getElementById('graph-explorer').classList.add('active');
  loadExplorer();
}
function closeGraphExplorer() {
  document.getElementById('graph-explorer').classList.remove('active');
  if (explorerSim) { explorerSim.stop(); explorerSim = null; }
}
document.getElementById('graph-explorer-btn').addEventListener('click', openGraphExplorer);
document.getElementById('ge-close-btn').addEventListener('click', closeGraphExplorer);
document.addEventListener('keydown', (e) => {
  if (e.code === 'Escape' && document.getElementById('graph-explorer').classList.contains('active')) {
    closeGraphExplorer();
  }
});

async function loadExplorer() {
  try {
    const r = await fetch(`${BASE}/api/graph?limit=500`);
    const d = await r.json();
    explorerData = { nodes: d.nodes || [], links: d.links || [] };
    document.getElementById('ge-stats').textContent =
      `${explorerData.nodes.length} nodes Â· ${explorerData.links.length} edges`;
    buildTypeFilters(explorerData.nodes);
    renderExplorer();
  } catch (e) { showToast('Graph load failed', 'red'); }
}

function buildTypeFilters(nodes) {
  const types = [...new Set(nodes.map(n => n.type))].sort();
  const container = document.getElementById('ge-type-filters');
  container.innerHTML = types.map(t => `
    <label class="ge-type-check">
      <input type="checkbox" class="ge-type-cb" value="${t}" checked />
      <span class="ge-dot" style="background:${GE_COLORS[t]||'#8b949e'}"></span>
      <span>${t}</span>
    </label>`).join('');
  container.querySelectorAll('.ge-type-cb').forEach(cb =>
    cb.addEventListener('change', applyExplorerFilters)
  );
}

function getExplorerFilters() {
  const search   = document.getElementById('ge-search').value.toLowerCase().trim();
  const minConf  = parseFloat(document.getElementById('ge-conf-slider').value) / 100;
  const checkedTypes = new Set(
    [...document.querySelectorAll('.ge-type-cb:checked')].map(cb => cb.value)
  );
  return { search, minConf, checkedTypes };
}

function applyExplorerFilters() {
  renderExplorer();
}

document.getElementById('ge-search').addEventListener('input', applyExplorerFilters);
document.getElementById('ge-conf-slider').addEventListener('input', function() {
  document.getElementById('ge-conf-val').textContent = (this.value / 100).toFixed(2);
  applyExplorerFilters();
});

function renderExplorer() {
  const { search, minConf, checkedTypes } = getExplorerFilters();

  const filteredNodes = explorerData.nodes.filter(n =>
    checkedTypes.has(n.type) &&
    n.confidence >= minConf &&
    (!search || n.label.toLowerCase().includes(search))
  );
  const filteredIds = new Set(filteredNodes.map(n => n.id));
  const filteredLinks = explorerData.links.filter(
    l => filteredIds.has(l.source?.id || l.source) && filteredIds.has(l.target?.id || l.target)
  );

  const svg = d3.select('#ge-svg');
  svg.selectAll('*').remove();

  const el = document.getElementById('ge-svg');
  const W = el.clientWidth || 800;
  const H = el.clientHeight || 600;

  if (filteredNodes.length === 0) {
    svg.append('text').attr('x', W/2).attr('y', H/2)
       .attr('text-anchor', 'middle').attr('fill', '#8b949e').attr('font-size', 14)
       .text('No nodes match the current filters');
    return;
  }

  // Deep-copy for simulation (avoid mutating source)
  const simNodes = filteredNodes.map(n => ({ ...n }));
  const nodeById  = new Map(simNodes.map(n => [n.id, n]));
  const simLinks  = filteredLinks
    .map(l => ({
      source: nodeById.get(l.source?.id || l.source),
      target: nodeById.get(l.target?.id || l.target),
      type: l.type, confidence: l.confidence,
    }))
    .filter(l => l.source && l.target);

  if (explorerSim) explorerSim.stop();
  explorerSim = d3.forceSimulation(simNodes)
    .force('link', d3.forceLink(simLinks).id(d => d.id).distance(65))
    .force('charge', d3.forceManyBody().strength(-80))
    .force('center', d3.forceCenter(W / 2, H / 2))
    .force('collision', d3.forceCollide(14));

  const g = svg.append('g');

  // Zoom / pan
  svg.call(d3.zoom().scaleExtent([0.1, 4]).on('zoom', ev => g.attr('transform', ev.transform)));

  // Links
  const link = g.append('g').selectAll('line').data(simLinks)
    .join('line').attr('class', 'ge-link').attr('stroke-width', d => 0.8 + d.confidence * 1.5);

  // Nodes
  const node = g.append('g').selectAll('g').data(simNodes).join('g')
    .attr('class', 'ge-node')
    .call(d3.drag()
      .on('start', (ev, d) => { if (!ev.active) explorerSim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on('drag',  (ev, d) => { d.fx = ev.x; d.fy = ev.y; })
      .on('end',   (ev, d) => { if (!ev.active) explorerSim.alphaTarget(0); d.fx = null; d.fy = null; })
    )
    .on('click', (ev, d) => { ev.stopPropagation(); selectExplorerNode(d.id); });

  node.append('circle')
    .attr('r', d => 5 + d.confidence * 9)
    .attr('fill', d => GE_COLORS[d.type] || '#8b949e')
    .attr('opacity', 0.88)
    .attr('stroke', d => explorerSelectedNode === d.id ? '#fff' : 'none')
    .attr('stroke-width', 2);

  node.append('text').attr('class', 'ge-label')
    .attr('dy', d => -(6 + d.confidence * 9))
    .attr('text-anchor', 'middle')
    .text(d => d.label.length > 22 ? d.label.substring(0, 22) + 'â€¦' : d.label);

  node.append('title').text(d => `${d.label}\n${d.type} | conf: ${d.confidence.toFixed(2)}`);

  svg.on('click', () => clearExplorerSelection());

  explorerSim.on('tick', () => {
    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    node.attr('transform', d => `translate(${d.x},${d.y})`);
  });
}

async function selectExplorerNode(nodeId) {
  explorerSelectedNode = nodeId;
  const detail = document.getElementById('ge-detail');
  detail.innerHTML = '<div class="ge-empty">Loadingâ€¦</div>';

  try {
    const r = await fetch(`${BASE}/api/graph/node/${nodeId}`);
    if (!r.ok) { detail.innerHTML = '<div class="ge-empty">Node not found</div>'; return; }
    const n = await r.json();

    const edgesHtml = n.edges.slice(0, 12).map(e => `
      <div class="ge-edge-item">
        <span class="ge-edge-dir">${e.direction === 'out' ? 'â†’' : 'â†'} ${e.edge_type}</span>
        <div style="color:var(--text);margin-top:2px">${escHtml(e.node_label)}</div>
      </div>`).join('');

    const propsHtml = Object.entries(n.properties || {}).slice(0, 8).map(([k, v]) => `
      <div class="ge-kv"><span class="ge-key">${escHtml(k)}</span><span class="ge-val">${escHtml(String(v))}</span></div>`
    ).join('');

    detail.innerHTML = `
      <div class="ge-detail-title">NODE DETAIL</div>
      <div class="ge-detail-label">${escHtml(n.label)}</div>
      <div class="ge-kv"><span class="ge-key">Type</span><span class="ge-val" style="color:${GE_COLORS[n.type]||'#8b949e'}">${n.type}</span></div>
      <div class="ge-kv"><span class="ge-key">Domain</span><span class="ge-val">${n.domain}</span></div>
      <div class="ge-kv"><span class="ge-key">Confidence</span><span class="ge-val">${n.confidence}</span></div>
      <div class="ge-kv"><span class="ge-key">Edges</span><span class="ge-val">${n.edge_count}</span></div>
      ${propsHtml ? `<div class="ge-detail-title" style="margin-top:4px">PROPERTIES</div>${propsHtml}` : ''}
      ${edgesHtml ? `<div class="ge-detail-title" style="margin-top:4px">CONNECTIONS</div><div style="display:flex;flex-direction:column;gap:4px">${edgesHtml}</div>` : ''}
      <button id="ge-delete-btn" onclick="deleteExplorerNode('${n.id}')">ğŸ—‘ Delete node</button>`;
  } catch (e) {
    detail.innerHTML = `<div class="ge-empty">Error: ${escHtml(e.message)}</div>`;
  }
}

function clearExplorerSelection() {
  explorerSelectedNode = null;
  document.getElementById('ge-detail').innerHTML = '<div class="ge-empty">Click a node to see details</div>';
}

async function deleteExplorerNode(nodeId) {
  if (!confirm('Delete this node from the knowledge graph?')) return;
  try {
    const r = await fetch(`${BASE}/api/graph/node/${nodeId}`, { method: 'DELETE' });
    const d = await r.json();
    if (d.success) {
      showToast(`Deleted: ${d.deleted}`);
      clearExplorerSelection();
      await loadExplorer();
    } else {
      showToast(d.error || 'Delete failed', 'red');
    }
  } catch (e) { showToast('Delete error: ' + e.message, 'red'); }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connect();
setInterval(loadStats, 15000);
setInterval(loadSessions, 30000);
setInterval(pollNotifications, 30000);
setTimeout(pollNotifications, 3000);  // First poll after 3s
</script>

<!-- â”€â”€ Notification Modal â”€â”€ -->
<div id="notif-modal">
  <div id="notif-header">
    <h3>ğŸ”” Notifications</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="hdr-btn" onclick="markAllRead()" style="padding:3px 8px;font-size:0.72rem">Mark all read</button>
      <button onclick="toggleNotifModal()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem">âœ•</button>
    </div>
  </div>
  <div id="notif-list"><div class="notif-empty">No notifications</div></div>
</div>

<!-- â”€â”€ Personality Panel â”€â”€ -->
<div id="personality-overlay" onclick="closePersonalityPanel()"></div>
<div id="personality-modal">
  <div id="personality-header">
    <div>
      <h2>âš™ Personality Calibration</h2>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:2px">TARS-style trait system Â· values 0%â€“100%</div>
    </div>
    <button onclick="closePersonalityPanel()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.3rem">âœ•</button>
  </div>
  <div id="personality-body">
    <div class="tars-label">"Humour calibrated to 75%. Honesty at 90%." â€” TARS</div>
    <div id="trait-sliders"></div>
  </div>
  <div id="personality-footer">
    <button class="hdr-btn" onclick="resetPersonality()">Reset Defaults</button>
    <button class="hdr-btn primary" onclick="savePersonality()">Apply Changes</button>
  </div>
</div>

<script>
// â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _notifModalOpen = false;

function toggleNotifModal() {
  _notifModalOpen = !_notifModalOpen;
  document.getElementById('notif-modal').classList.toggle('open', _notifModalOpen);
  if (_notifModalOpen) pollNotifications(true);
}

async function pollNotifications(forceRender = false) {
  try {
    const r = await fetch(`${BASE}/api/notifications?unread_only=false&limit=20`);
    if (!r.ok) return;
    const data = await r.json();
    const count = data.unread_count || 0;
    const countEl = document.getElementById('notif-count');
    if (count > 0) {
      countEl.textContent = count > 9 ? '9+' : count;
      countEl.classList.remove('hidden');
    } else {
      countEl.classList.add('hidden');
    }
    if (_notifModalOpen || forceRender) {
      renderNotifications(data.notifications || []);
    }
  } catch (e) { /* server may not be ready */ }
}

function renderNotifications(notifications) {
  const list = document.getElementById('notif-list');
  if (!notifications.length) {
    list.innerHTML = '<div class="notif-empty">All clear â€” no notifications</div>';
    return;
  }
  list.innerHTML = notifications.map(n => `
    <div class="notif-item ${n.read ? '' : 'unread'}" onclick="handleNotifClick('${n.id}', '${n.action || ''}')">
      <div class="notif-title">${escHtml(n.title)}</div>
      <div class="notif-msg">${escHtml(n.message)}</div>
      <div class="notif-time">${n.time_str || ''}</div>
    </div>
  `).join('');
}

async function handleNotifClick(id, action) {
  await fetch(`${BASE}/api/notifications/${id}/read`, { method: 'POST' });
  pollNotifications(true);
  if (action && action.startsWith('complete_reminder:')) {
    const remId = action.split(':')[1];
    await fetch(`${BASE}/api/reminders/${remId}/complete`, { method: 'PATCH' });
    showToast('Reminder completed âœ“');
  }
  if (!action || action === 'open_chat') {
    toggleNotifModal();
  }
}

async function markAllRead() {
  await fetch(`${BASE}/api/notifications/read-all`, { method: 'POST' });
  pollNotifications(true);
}

// â”€â”€ Personality Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TRAIT_META = [
  { key: 'humor_level',      label: 'Humor',      desc: '0% = deadpan | 100% = full comedian' },
  { key: 'wit_level',        label: 'Wit',         desc: '0% = literal | 100% = razor-sharp layered wit' },
  { key: 'directness_level', label: 'Directness',  desc: '0% = verbose | 100% = blunt, no padding' },
  { key: 'warmth_level',     label: 'Warmth',      desc: '0% = clinical | 100% = deeply warm' },
  { key: 'sass_level',       label: 'Sass',        desc: '0% = deferential | 100% = maximum Jarvis' },
  { key: 'formality_level',  label: 'Formality',   desc: '0% = casual | 100% = formal' },
  { key: 'proactive_level',  label: 'Proactive',   desc: '0% = reactive | 100% = always ahead' },
  { key: 'empathy_level',    label: 'Empathy',     desc: '0% = analytical | 100% = mood-sensitive' },
  { key: 'curiosity_level',  label: 'Curiosity',   desc: '0% = task-only | 100% = always asks follow-ups' },
];
let _currentTraits = {};

async function openPersonalityPanel() {
  document.getElementById('personality-overlay').classList.add('open');
  document.getElementById('personality-modal').classList.add('open');
  await loadPersonality();
}

function closePersonalityPanel() {
  document.getElementById('personality-overlay').classList.remove('open');
  document.getElementById('personality-modal').classList.remove('open');
}

async function loadPersonality() {
  try {
    const r = await fetch(`${BASE}/api/personality`);
    if (!r.ok) return;
    const data = await r.json();
    _currentTraits = data.traits || {};
    renderTraitSliders();
  } catch (e) { showToast('Could not load personality', 'red'); }
}

function renderTraitSliders() {
  const container = document.getElementById('trait-sliders');
  container.innerHTML = TRAIT_META.map(t => {
    const val = _currentTraits[t.key] ?? 0.75;
    const pct = Math.round(val * 100);
    return `
      <div class="trait-row">
        <div class="trait-label">
          <span class="trait-name">${t.label}</span>
          <span class="trait-val" id="lbl-${t.key}">${pct}%</span>
        </div>
        <input type="range" class="trait-slider" min="0" max="100" value="${pct}"
          oninput="onTraitSlide('${t.key}', this.value)" />
        <div class="trait-desc">${t.desc}</div>
      </div>`;
  }).join('');
}

function onTraitSlide(key, pctStr) {
  const pct = parseInt(pctStr);
  _currentTraits[key] = pct / 100;
  document.getElementById(`lbl-${key}`).textContent = pct + '%';
}

async function savePersonality() {
  try {
    const r = await fetch(`${BASE}/api/personality`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(_currentTraits),
    });
    if (!r.ok) throw new Error('Save failed');
    const data = await r.json();
    showToast(`Personality updated: ${data.updated.length} trait(s) changed`);
    closePersonalityPanel();
  } catch (e) { showToast('Save failed: ' + e.message, 'red'); }
}

async function resetPersonality() {
  const defaults = {
    humor_level: 0.75, wit_level: 0.82, directness_level: 0.88,
    warmth_level: 0.72, sass_level: 0.38, formality_level: 0.12,
    proactive_level: 0.82, empathy_level: 0.78, curiosity_level: 0.68,
  };
  _currentTraits = { ...defaults };
  renderTraitSliders();
  await savePersonality();
}
</script>
</body>
</html>
